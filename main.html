<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éçº¿æ€§æ›²çº¿æ‹Ÿåˆå·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2rem);
            margin-bottom: 5px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding: 20px;
        }

        @media (min-width: 1024px) {
            .main-content {
                grid-template-columns: 400px 1fr;
            }
        }

        .panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .results {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }

        .result-item {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .result-label {
            font-weight: 600;
            color: #667eea;
        }

        .result-value {
            padding: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #0066cc;
        }

        .equation {
            text-align: center;
            font-size: 1.1rem;
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border-radius: 6px;
            color: #856404;
        }

        .data-input-container {
            background: white;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .data-table {
            display: grid;
            gap: 10px;
            min-width: 100%;
        }

        .data-row {
            display: grid;
            grid-template-columns: 60px 1fr 1fr;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .data-row {
                grid-template-columns: 50px 1fr 1fr;
            }
        }

        .data-header {
            font-weight: bold;
            text-align: center;
            color: #667eea;
        }

        .data-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
        }

        .data-index {
            text-align: center;
            font-weight: 600;
            color: #666;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ éçº¿æ€§æ›²çº¿æ‹Ÿåˆå·¥å…·</h1>
            <p>y = C + Câ‚/(e^(-kt) + Câ‚‚)</p>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="left-panel">
                <div class="panel">
                    <div class="panel-title">å‚æ•°è®¾ç½®</div>
                    
                    <div class="form-group">
                        <label>åˆå§‹å‚æ•° C:</label>
                        <input type="number" id="paramC" value="142.72" step="any">
                    </div>

                    <div class="form-group">
                        <label>åˆå§‹å‚æ•° Câ‚:</label>
                        <input type="number" id="paramC1" value="-770.60" step="any">
                    </div>

                    <div class="form-group">
                        <label>åˆå§‹å‚æ•° Câ‚‚:</label>
                        <input type="number" id="paramC2" value="4.22664" step="any">
                    </div>

                    <div class="form-group">
                        <label>åˆå§‹å‚æ•° k:</label>
                        <input type="number" id="paramK" value="0.29397" step="any">
                    </div>

                    <div class="form-group">
                        <label>æ•°æ®è¾“å…¥æ–¹å¼:</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="dataSource" value="manual" checked>
                                æ‰‹åŠ¨è¾“å…¥
                            </label>
                            <label>
                                <input type="radio" name="dataSource" value="file">
                                æ–‡ä»¶å¯¼å…¥
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Xé‡‡æ ·ç‚¹æ•°:</label>
                        <input type="number" id="numPoints" value="10" min="2" max="1000" step="1">
                    </div>

                    <div class="form-group">
                        <label>æ•°æ®æ–‡ä»¶ (CSV/Excel):</label>
                        <div class="file-input-wrapper">
                            <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                                å¯¼å…¥æ–‡ä»¶
                            </button>
                            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="generateInputFields()">
                        ç”ŸæˆYæ•°æ®è¾“å…¥æ¡†
                    </button>

                    <button class="btn btn-primary" onclick="performFitting()">
                        ğŸš€ æ‰§è¡Œæ‹Ÿåˆ
                    </button>

                    <div class="results">
                        <div class="panel-title" style="font-size: 1rem;">æ‹Ÿåˆç»“æœ</div>
                        <div class="result-item">
                            <span class="result-label">C =</span>
                            <span class="result-value" id="resultC">0.000000</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Câ‚ =</span>
                            <span class="result-value" id="resultC1">0.000000</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Câ‚‚ =</span>
                            <span class="result-value" id="resultC2">0.000000</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">k =</span>
                            <span class="result-value" id="resultK">0.000000</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">RÂ² =</span>
                            <span class="result-value" id="resultR2" style="color: #ff6b00; font-weight: bold;">0.00000000</span>
                        </div>
                        <div class="equation" id="equationDisplay">
                            y = C + Câ‚/(e^(-kt) + Câ‚‚)
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ -->
            <div class="right-panel">
                <div class="panel">
                    <div class="panel-title">æ•°æ®è¾“å…¥</div>
                    <div class="data-input-container" id="dataInputContainer">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„è¾“å…¥æ¡† -->
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">æ‹Ÿåˆæ›²çº¿</div>
                    <div class="chart-container">
                        <canvas id="fittingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="alertContainer"></div>
    </div>

    <script>
        let xData = [];
        let yData = [];
        let chart = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            generateInputFields();
            initChart();
        });

        // æ–‡ä»¶å¯¼å…¥
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const content = event.target.result;
                    Papa.parse(content, {
                        complete: function(results) {
                            const data = results.data.filter(row => row.length >= 2 && row[0] && row[1]);
                            if (data.length === 0) {
                                showAlert('æ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®', 'error');
                                return;
                            }
                            
                            xData = data.map(row => parseFloat(row[0]));
                            yData = data.map(row => parseFloat(row[1]));
                            
                            document.getElementById('numPoints').value = xData.length;
                            document.querySelector('input[name="dataSource"][value="file"]').checked = true;
                            
                            generateInputFields();
                            showAlert(`æˆåŠŸå¯¼å…¥ ${xData.length} ä¸ªæ•°æ®ç‚¹`, 'success');
                        },
                        error: function() {
                            showAlert('æ–‡ä»¶è§£æå¤±è´¥', 'error');
                        }
                    });
                } catch (error) {
                    showAlert('æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        });

        // ç”Ÿæˆè¾“å…¥æ¡†
        function generateInputFields() {
            const numPoints = parseInt(document.getElementById('numPoints').value);
            const container = document.getElementById('dataInputContainer');
            const isFileMode = document.querySelector('input[name="dataSource"][value="file"]').checked;
            
            if (!isFileMode || xData.length !== numPoints) {
                xData = Array.from({length: numPoints}, (_, i) => i * 9 / (numPoints - 1));
                yData = Array(numPoints).fill(0);
            }
            
            let html = '<div class="data-table">';
            html += '<div class="data-row">';
            html += '<div class="data-header">åºå·</div>';
            html += '<div class="data-header">Xå€¼</div>';
            html += '<div class="data-header">Yå€¼</div>';
            html += '</div>';
            
            for (let i = 0; i < numPoints; i++) {
                html += '<div class="data-row">';
                html += `<div class="data-index">${i + 1}</div>`;
                html += `<input type="number" class="data-input" id="x${i}" value="${xData[i].toFixed(4)}" step="any" onchange="updateData()">`;
                html += `<input type="number" class="data-input" id="y${i}" value="${yData[i].toFixed(4)}" step="any" onchange="updateData()">`;
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            performFitting();
        }

        // æ›´æ–°æ•°æ®
        function updateData() {
            const numPoints = parseInt(document.getElementById('numPoints').value);
            for (let i = 0; i < numPoints; i++) {
                xData[i] = parseFloat(document.getElementById(`x${i}`).value);
                yData[i] = parseFloat(document.getElementById(`y${i}`).value);
            }
            performFitting();
        }

        // è‡ªå®šä¹‰å‡½æ•°
        function customFunction(params, t) {
            const [C, C1, C2, k] = params;
            return t.map(ti => C + C1 / (Math.exp(-k * ti) + C2));
        }

        // ç®€åŒ–çš„éçº¿æ€§æ‹Ÿåˆï¼ˆæœ€å°äºŒä¹˜æ³• + æ¢¯åº¦ä¸‹é™ï¼‰
        function lsqcurvefit(func, initialGuess, xData, yData) {
            let params = [...initialGuess];
            const learningRate = 0.001;
            const maxIterations = 10000;
            const epsilon = 1e-8;
            
            for (let iter = 0; iter < maxIterations; iter++) {
                const yPred = func(params, xData);
                const residuals = yData.map((y, i) => y - yPred[i]);
                const error = residuals.reduce((sum, r) => sum + r * r, 0);
                
                if (error < epsilon) break;
                
                // æ•°å€¼æ¢¯åº¦è®¡ç®—
                const gradients = params.map((p, idx) => {
                    const delta = 1e-6;
                    const paramsPlus = [...params];
                    paramsPlus[idx] += delta;
                    const yPlus = func(paramsPlus, xData);
                    const errorPlus = yData.reduce((sum, y, i) => sum + Math.pow(y - yPlus[i], 2), 0);
                    return (errorPlus - error) / delta;
                });
                
                // æ›´æ–°å‚æ•°
                params = params.map((p, i) => p - learningRate * gradients[i]);
            }
            
            return params;
        }

        // æ‰§è¡Œæ‹Ÿåˆ
        function performFitting() {
            if (xData.length === 0 || yData.length === 0) return;
            
            try {
                const initialGuess = [
                    parseFloat(document.getElementById('paramC').value),
                    parseFloat(document.getElementById('paramC1').value),
                    parseFloat(document.getElementById('paramC2').value),
                    parseFloat(document.getElementById('paramK').value)
                ];
                
                const fitParams = lsqcurvefit(customFunction, initialGuess, xData, yData);
                
                // è®¡ç®—RÂ²
                const yFit = customFunction(fitParams, xData);
                const SSE = yData.reduce((sum, y, i) => sum + Math.pow(y - yFit[i], 2), 0);
                const yMean = yData.reduce((sum, y) => sum + y, 0) / yData.length;
                const SST = yData.reduce((sum, y) => sum + Math.pow(y - yMean, 2), 0);
                const R2 = 1 - SSE / SST;
                
                // æ›´æ–°ç»“æœæ˜¾ç¤º
                document.getElementById('resultC').textContent = fitParams[0].toFixed(6);
                document.getElementById('resultC1').textContent = fitParams[1].toFixed(6);
                document.getElementById('resultC2').textContent = fitParams[2].toFixed(6);
                document.getElementById('resultK').textContent = fitParams[3].toFixed(6);
                document.getElementById('resultR2').textContent = R2.toFixed(8);
                
                // æ›´æ–°æ–¹ç¨‹æ˜¾ç¤º
                document.getElementById('equationDisplay').textContent = 
                    `y = ${fitParams[0].toFixed(4)} + ${fitParams[1].toFixed(4)}/(e^(-${fitParams[3].toFixed(4)}t) + ${fitParams[2].toFixed(4)})`;
                
                // ç»˜åˆ¶å›¾è¡¨
                updateChart(fitParams, R2);
                
            } catch (error) {
                showAlert('æ‹Ÿåˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('fittingChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'å®é™…æ•°æ®',
                        data: [],
                        backgroundColor: 'rgb(102, 126, 234)',
                        borderColor: 'rgb(102, 126, 234)',
                        pointRadius: 6
                    }, {
                        label: 'æ‹Ÿåˆæ›²çº¿',
                        data: [],
                        type: 'line',
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'éçº¿æ€§æ›²çº¿æ‹Ÿåˆ',
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 't' }
                        },
                        y: {
                            title: { display: true, text: 'w' }
                        }
                    }
                }
            });
        }

        // æ›´æ–°å›¾è¡¨
        function updateChart(fitParams, R2) {
            const actualData = xData.map((x, i) => ({x: x, y: yData[i]}));
            
            const minX = Math.min(...xData);
            const maxX = Math.max(...xData);
            const tFit = Array.from({length: 200}, (_, i) => minX + (maxX - minX) * i / 199);
            const wFit = customFunction(fitParams, tFit);
            const fittedData = tFit.map((t, i) => ({x: t, y: wFit[i]}));
            
            chart.data.datasets[0].data = actualData;
            chart.data.datasets[1].data = fittedData;
            chart.options.plugins.title.text = `éçº¿æ€§æ›²çº¿æ‹Ÿåˆ (RÂ² = ${R2.toFixed(6)})`;
            chart.update();
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
    </script>
</body>
</html>
